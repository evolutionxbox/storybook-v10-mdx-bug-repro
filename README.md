# Storybook v10 MDX file:// URL Bug Reproduction

Minimal reproduction repository for a bug in Storybook v10.1.11 where the MDX compiler generates `file://` URLs instead of module specifiers in Yarn workspaces + Turborepo monorepos, causing Vite to fail.

## Problem

When upgrading from Storybook 9.1.17 to 10.1.11 in a monorepo with `.storybook/` in a subdirectory (not at root), the MDX compiler generates `file://` URLs:

```javascript
// Generated by Storybook v10 MDX compiler:
import { useMDXComponents } from "file:///absolute/path/to/node_modules/@storybook/addon-docs/dist/mdx-react-shim.js";
```

This causes Vite's import analysis to fail with:

```
Failed to resolve import "file:///..." from "Introduction.mdx"
```

### Expected Behavior

MDX files should compile with standard module specifiers:

```javascript
import { useMDXComponents } from "@storybook/addon-docs/mdx-react-shim";
```

## Reproduction Steps

### 1. Clone and Install

```bash
git clone https://github.com/evolutionxbox/storybook-v10-mdx-bug-repro.git
cd storybook-v10-mdx-bug-repro
yarn install
```

### 2. Reproduce the Bug

```bash
yarn storybook
```

**Expected**: Storybook fails to start with error:

```
Failed to resolve import "file:///..." from "Introduction.mdx"
```

### 3. Verify the Workaround

```bash
# Copy the working configuration
cp .storybook/main.workaround.ts .storybook/main.ts

# Restart Storybook
yarn storybook
```

**Expected**: Storybook starts successfully and MDX files render correctly.

## Environment

- **Storybook**: 10.1.11
- **Framework**: @storybook/react-vite
- **Builder**: Vite 5.4.21
- **Package Manager**: Yarn 4.9.1 (workspaces)
- **Monorepo Tool**: Turborepo 2.6.0
- **React**: 19.2.3
- **`.storybook/` location**: `packages/ui/.storybook/` (not at root)

## Workaround

This repository includes a workaround via the `@repo/storybook-mdx-fix` workspace package, which provides a Vite plugin that transforms `file://` URLs back to module specifiers.

### Usage

See [`packages/ui/.storybook/main.workaround.ts`](./packages/ui/.storybook/main.workaround.ts) for the working configuration:

```typescript
import { fixStorybookMdxImports } from "@repo/storybook-mdx-fix";

export default {
  async viteFinal(config) {
    config.plugins = config.plugins || [];
    config.plugins.push(fixStorybookMdxImports());
    return config;
  },
};
```

See [`packages/storybook-mdx-fix/README.md`](./packages/storybook-mdx-fix/README.md) for more details about the plugin.

## Related Issues

This bug is related to but distinct from:

- [#33362](https://github.com/storybookjs/storybook/issues/33362) - MDX resolution in monorepos (doesn't address file:// URL generation)
- [#33287](https://github.com/storybookjs/storybook/issues/33287) - Path resolution when .storybook not at root (focuses on addons, not MDX)
- [#33118](https://github.com/storybookjs/storybook/issues/33118) - MDX doc blocks import issues (different import path issue)
- [#32604](https://github.com/storybookjs/storybook/issues/32604) - file:// URL resolution with MDX (Angular context, no fix)
- [#33426](https://github.com/storybookjs/storybook/issues/33426) - getAbsolutePath issues in monorepos (addon registration, not MDX)

## Bug Report

Filed at: [Link to be added]

## Repository Structure

```
storybook-v10-mdx-bug-repro/
├── packages/
│   ├── storybook-mdx-fix/     # Workaround Vite plugin
│   │   ├── index.ts
│   │   ├── package.json
│   │   └── README.md
│   └── ui/                     # UI package with Storybook
│       ├── .storybook/
│       │   ├── main.ts         # Broken config (triggers bug)
│       │   ├── main.workaround.ts  # Working config (with plugin)
│       │   └── preview.tsx
│       ├── lib/
│       │   └── button/
│       │       ├── button.component.tsx
│       │       └── button.stories.tsx
│       ├── Introduction.mdx    # Triggers the bug
│       └── package.json
├── package.json                # Root with workspaces config
├── turbo.json
└── README.md
```

## License

MIT
